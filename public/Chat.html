<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ConnectHer Chat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="theme.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background-color: #121212;
      color: #fff;
      padding: 10px;
      max-width: 480px;
      margin: auto;
    }
    
body {
  background-color: var(--bg);
  color: var(--text);
}
    .header {
      padding: 10px 0;
      font-size: 24px;
      font-weight: bold;
      color: #ff4081;
    }

    .search-bar {
      margin: 10px 0;
      display: flex;
      align-items: center;
      background-color: #1e1e1e;
      border-radius: 25px;
      padding: 8px 15px;
    }

    .search-bar input {
      background: none;
      border: none;
      outline: none;
      color: #fff;
      flex: 1;
      margin-left: 10px;
      font-size: 16px;
    }

    .status-filter {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }

    .status-btn {
      padding: 5px 10px;
      background-color: #1e1e1e;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      color: #ccc;
    }

    .status-btn.active {
      background-color: #ff4081;
      color: #fff;
    }

    .chat-tile {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #333;
      cursor: pointer;
    }

    .chat-tile img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
      position: relative;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      right: 2px;
      border: 2px solid #121212;
    }

    .online-indicator {
      background-color: #00ff00;
    }

    .offline-indicator {
      background-color: #555;
    }

    .chat-info {
      flex: 1;
    }

    .chat-info .name {
      font-weight: bold;
      font-size: 16px;
      color: #f173d6;
    }

    .chat-info .message {
      font-size: 14px;
      color: #ccc;
    }

    .chat-time {
      font-size: 12px;
      color: #888;
    }

    .avatar-wrapper {
      position: relative;
    }

    /* Profile View */
    .profile-container {
      display: none;
      flex-direction: row;
      align-items: flex-start;
      padding: 20px;
      gap: 20px;
    }

    .profile-container.active {
      display: flex;
    }

    .avatar-large {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #ff4081;
      flex-shrink: 0;
    }

    .profile-details {
      flex: 1;
    }

    .full-name {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .username {
      font-size: 16px;
      color: #bbb;
      margin-bottom: 5px;
    }

    .location {
      font-size: 14px;
      color: #999;
      margin-bottom: 10px;
    }

    .status {
      font-size: 14px;
      color: #0f0;
      margin-bottom: 15px;
    }

    .bio {
      font-size: 15px;
      color: #ccc;
      margin-bottom: 25px;
    }

    .actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .btn {
      background-color: #ff4081;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 25px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn.secondary {
      background-color: #333;
    }

    .clickable {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="chatSection">
    <div class="header">Chats</div>

    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Search or start a new chat" oninput="searchChats()">
    </div>

    <div class="status-filter">
      <div class="status-btn active" onclick="setStatusFilter('online')">Online</div>
      <div class="status-btn" onclick="setStatusFilter('offline')">Away/Offline</div>
    </div>
</div>


  <!-- Full Image Modal with Download -->
<div id="fullImageModal" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.9);
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 999;
">
  <img id="fullImage" src="" alt="Full Profile Picture" style="max-width: 90vw; max-height: 80vh; border-radius: 10px; margin-bottom: 15px;">
  <a id="downloadBtn" href="#" download class="btn" style="
    background-color: #ff4081;
    color: white;
    text-decoration: none;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 14px;
  ">Download Picture</a>
</div>


  <!-- Profile View Section -->
  <div class="profile-container" id="profileView">
    <img id="profileAvatar" src="" alt="User" class="avatar-large">
    <div class="profile-details">
      <div class="full-name" id="profileName">Esther Michael</div>
      <div class="username" id="profileUsername">@queenesther</div>
      <div class="location" id="profileLocation">Lagos, Nigeria</div>
      <div class="status" id="profileStatus">Online now</div>
      <div class="bio" id="profileBio">Lover of peace and tech 💕. Let's ConnectHer and grow together!</div>

      <div class="actions">
  <button class="btn" onclick="openConversation()">Send Message</button>
  <button class="btn secondary" onclick="goBack()">Back</button>
</div>

    </div>
  </div>

<!-- Full Image Modal -->
<div id="fullImageModal" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.85);
  justify-content: center;
  align-items: center;
  z-index: 999;
">
  <img id="fullImage" src="" alt="Full Profile Picture" style="max-width: 90vw; max-height: 90vh; border-radius: 10px;">
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <script>
  localStorage.setItem("activePage", "Chat.html");

  let currentStatusFilter = 'online';
    function setStatusFilter(status) {
      currentStatusFilter = status;
      document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.status-btn[onclick*="${status}"]`).classList.add('active');
      applyFilters();
    }
  const socket = io("https://connecther.network");
  const currentUser = JSON.parse(localStorage.getItem("currentUser"));
  socket.emit("register", currentUser.username);

    function searchChats() {
      applyFilters();
    }
    
    function applyFilters() {
      const searchValue = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('.chat-tile').forEach(tile => {
        const name = tile.querySelector('.name').textContent.toLowerCase();
        const status = tile.dataset.status;
        if (searchValue) {
          tile.style.display = name.includes(searchValue) ? 'flex' : 'none';
        } else {
          tile.style.display = status === currentStatusFilter ? 'flex' : 'none';
        }
      });
    }

    function showProfile(name, username, location, status, avatarUrl, bio) {
      document.getElementById('chatSection').style.display = 'none';
      document.getElementById('profileView').classList.add('active');

      document.getElementById('profileName').textContent = name;
      document.getElementById('profileUsername').textContent = username;
      document.getElementById('profileLocation').textContent = location;
      document.getElementById('profileStatus').textContent = status;
      document.getElementById('profileAvatar').src = avatarUrl;
      document.getElementById('profileBio').textContent = bio;
    }

    function goBack() {
      document.getElementById('profileView').classList.remove('active');
      document.getElementById('chatSection').style.display = 'block';
    }
    // Full image modal display logic
const profileAvatar = document.getElementById("profileAvatar");
const fullImageModal = document.getElementById("fullImageModal");
const fullImage = document.getElementById("fullImage");

profileAvatar.addEventListener("click", (e) => {
  fullImage.src = profileAvatar.src;
  fullImageModal.style.display = "flex";
});

fullImageModal.addEventListener("click", () => {
  fullImageModal.style.display = "none";
});
{// Full image modal display and download
const profileAvatar = document.getElementById("profileAvatar");
const fullImageModal = document.getElementById("fullImageModal");
const fullImage = document.getElementById("fullImage");
const downloadBtn = document.getElementById("downloadBtn");

profileAvatar.addEventListener("click", () => {
  const imgSrc = profileAvatar.src;
  fullImage.src = imgSrc;
  downloadBtn.href = imgSrc;
  fullImageModal.style.display = "flex";
});

fullImageModal.addEventListener("click", (e) => {
  if (e.target === fullImageModal || e.target === fullImage) {
    fullImageModal.style.display = "none";
  }
});
}

function openConversation() {
    window.location.href = "http://127.0.0.1:5500/conversation.html";
  }
function openProfile(username) {
  window.location.href = `profile.html?user=${username}`;
}

window.addEventListener("DOMContentLoaded", () => {
  const currentUser = JSON.parse(localStorage.getItem("currentUser"));
  const chatSection = document.getElementById("chatSection");

  fetch(`https://connecther.network/api/friends/${currentUser.username}`)
    .then(res => res.json())
    .then(friendList => {

      friendList.forEach(friend => {
        const isOnline = friend.status === "online"; // You can later track real status
        const tile = document.createElement("div");
        tile.className = "chat-tile";
        tile.setAttribute("data-username", friend.username);
        tile.setAttribute("data-status", isOnline ? "online" : "offline");

        tile.innerHTML = `
          <div class="avatar-wrapper clickable" onclick="openProfile('${friend.username}')">
            <img src="${friend.avatar}" alt="${friend.name}">
            <div class="status-indicator ${isOnline ? "online-indicator" : "offline-indicator"}"></div>
          </div>
          <div class="chat-info">
            <div class="name clickable" onclick="openProfile('${friend.username}')">${friend.name}</div>
            <div class="message">Say hi 👋</div>
          </div>
          <div class="chat-time">Now</div>
        `;

        tile.addEventListener("click", () => {
          window.location.href = `conversation.html?user=${friend.username}`;
        });

        chatSection.appendChild(tile);
      });


fetch(`https://connecther.network/api/messages/latest/${currentUser.username}`)
  .then(res => res.json())
  .then(latestMessages => {
    console.log("🧪 LatestMessages from server:", latestMessages);
    
    latestMessages.forEach(entry => {
      const friendUsername = entry.friend?.toLowerCase();
      const tile = document.querySelector(`.chat-tile[data-username="${friendUsername}"]`);
      if (!tile) return;

      let preview = "Say hi 👋";
      if (entry.lastMessage) {
        const msg = entry.lastMessage;
        if (msg.text && msg.text.trim()) {
          preview = msg.text.trim();
        } else if (msg.media && msg.media.length > 0) {
          preview = "📷 Media";
        } else if (msg.audio && msg.audio.trim()) {
          preview = "🎙️ Voice Note";
        }
      }
      const messageDiv = tile.querySelector(".message");
      if (messageDiv) {
        messageDiv.textContent = preview;
        console.log("✅ Matched:", friendUsername, "→", preview);
      }
    });
  })
  .catch(err => {
    console.error("❌ Failed to load last message previews:", err);
  });
    })
    .catch(err => {
      console.error("❌ Failed to load friends:", err);
    });
});


socket.on("update-online-users", (onlineUsernames) => {
  document.querySelectorAll(".chat-tile").forEach(tile => {
    const username = tile.getAttribute("data-username");
    const avatar = tile.querySelector(".status-indicator");

    if (onlineUsernames.includes(username)) {
      tile.setAttribute("data-status", "online");
      avatar.classList.add("online-indicator");
      avatar.classList.remove("offline-indicator");
    } else {
      tile.setAttribute("data-status", "offline");
      avatar.classList.add("offline-indicator");
      avatar.classList.remove("online-indicator");
    }
  });

  sortFriendTiles(); // ⬅ Sort them after status update
});

function sortFriendTiles() {
  const chatSection = document.getElementById("chatSection");
  const tiles = Array.from(document.querySelectorAll(".chat-tile"));

  tiles.sort((a, b) => {
    const aStatus = a.getAttribute("data-status");
    const bStatus = b.getAttribute("data-status");

    // ✅ Sort online first
    if (aStatus === "online" && bStatus !== "online") return -1;
    if (aStatus !== "online" && bStatus === "online") return 1;

    // Future: compare by latest chat time
    return 0;
  });

  tiles.forEach(tile => chatSection.appendChild(tile)); // Re-render sorted
}


  </script>
<script src="theme.js" defer></script>

<script type="module">
  import { App } from 'https://cdn.jsdelivr.net/npm/@capacitor/app@5/dist/index.js';

  document.addEventListener('DOMContentLoaded', () => {
    App.addListener('backButton', () => {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        App.exitApp();
      }
    });
  });
</script>
</body>
</html>
