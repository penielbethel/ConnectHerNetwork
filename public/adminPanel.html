<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      box-sizing: border-box;
    }

    body {
      background: #0e0e0e;
      color: #fff;
      padding: 20px;
    }

    h1, h2 {
      margin-bottom: 10px;
    }

    .section {
      margin-bottom: 30px;
    }

    .box {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
    }

    input, textarea, button, select {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 15px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
    }

    button {
      background: #e42ca6;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .sponsor-card {
      background: #2c2c2c;
      margin-top: 10px;
      padding: 12px;
      border-radius: 6px;
    }

    .sponsor-card img {
      max-width: 100px;
      height: auto;
      display: block;
      margin-bottom: 10px;
    }

    .preview {
      margin-top: 8px;
      border: 1px dashed #444;
      padding: 8px;
      border-radius: 6px;
    }

    .preview img, .preview video {
      max-width: 100%;
      border-radius: 6px;
    }

    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-content {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }

    .modal-content h3 {
      margin-bottom: 10px;
    }

    .close-btn {
      background: #444;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h1>üìä Admin Panel</h1>

<button 
  style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;"
  onclick="window.location='dashboard.html'">
  <i class="fa fa-home"></i>
</button>

  <div class="section">
    <h2>Total Users:</h2>
    <div class="box" id="userCount">Loading...</div>
  </div>

  <div class="section">
    <h2>Register Sponsor</h2>
    <div class="box">
      <form id="sponsorForm">
        <input type="text" id="companyName" placeholder="Company Name" required />
        <input type="file" id="logo" accept="image/*" required />
        <div id="logoPreview" class="preview" style="display:none;"></div>
        <textarea id="objectives" placeholder="Objectives" required></textarea>
        <button type="submit">Register Sponsor</button>
      </form>
    </div>
  </div>

  <div class="section">
    <h2>Registered Sponsors</h2>
    <div id="sponsorList" class="box">
      Loading sponsors...
    </div>
  </div>

  <!-- Modal for posting -->
  <div class="modal" id="postModal">
    <div class="modal-content">
      <h3>Post for Sponsor</h3>
      <form id="postForm">
        <input type="hidden" id="modalSponsorId" />
        <input type="hidden" id="modalPostId" />
        <input type="file" id="postMedia" accept="image/*,video/*" required />
        <div id="postMediaPreview" class="preview" style="display:none;"></div>
        <textarea id="postCaption" placeholder="Write caption..." required></textarea>
        <input type="url" id="jobLink" placeholder="Link to Job Posting" required />
        <button type="submit">Submit Post</button>
        <button type="button" class="close-btn" onclick="closeModal()">Cancel</button>
      </form>
    </div>
  </div>

  <script>
const token = localStorage.getItem("token");

// Basic guard if token is missing
if (!token) {
  console.warn("Admin token missing. Please login to the admin panel.");
}

// ----------------- FETCH DATA -----------------
async function fetchUserCount() {
  const res = await fetch("/api/users/count", { headers: { "Authorization": "Bearer " + token } });
  const data = await res.json();
  document.getElementById("userCount").innerText = res.ok ? data.count : "Error loading count";
}

async function fetchSponsors() {
  const res = await fetch("/api/sponsors", { headers: { "Authorization": "Bearer " + token } });
  const data = await res.json();
  const container = document.getElementById("sponsorList");
  container.innerHTML = "";

  if (res.ok && Array.isArray(data)) {
    data.forEach(s => {
      const div = document.createElement("div");
      div.className = "sponsor-card";
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <img src="${s.logo}" alt="${s.companyName}" style="max-width:80px;" />
          <button onclick="deleteSponsor('${s._id}')" style="color:red;border:none;cursor:pointer;">‚ùå</button>
        </div>
        <strong>${s.companyName}</strong><br>
        <small>${s.objectives}</small><br>
        <button onclick="openModal('${s._id}')">Post for this Sponsor</button>
        <button onclick="togglePosts('${s._id}', this)">Show Posts</button>
        <div id="posts-${s._id}" class="post-list" style="display:none;"></div>
      `;
      container.appendChild(div);
    });
  } else {
    container.innerText = "No sponsors found.";
  }
}

// ----------------- SPONSOR CRUD -----------------
document.getElementById("sponsorForm").addEventListener("submit", async e => {
  e.preventDefault();
  const logoInput = document.getElementById("logo");
  if (!logoInput.files || !logoInput.files[0]) {
    alert("Please select a logo image");
    return;
  }
  const file = logoInput.files[0];
  if (!file.type.startsWith("image/")) {
    alert("Logo must be an image file");
    return;
  }
  if (file.size > 5 * 1024 * 1024) {
    alert("Logo image too large (max 5MB)");
    return;
  }
  const formData = new FormData();
  formData.append("companyName", document.getElementById("companyName").value);
  formData.append("logo", file);
  formData.append("objectives", document.getElementById("objectives").value);

  const res = await fetch("/api/sponsors/register", {
    method: "POST",
    headers: { "Authorization": "Bearer " + token },
    body: formData
  });

  if (res.ok) {
    alert("‚úÖ Sponsor registered");
    fetchSponsors();
    document.getElementById("sponsorForm").reset();
  } else {
    alert("‚ùå Error registering sponsor");
  }
});

async function deleteSponsor(sponsorId) {
  if (!confirm("Are you sure you want to delete this sponsor?")) return;
  const res = await fetch(`/api/sponsors/${sponsorId}`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  });
  if (res.ok) {
    alert("‚úÖ Sponsor deleted");
    fetchSponsors();
  } else {
    alert("‚ùå Failed to delete sponsor");
  }
}

// ----------------- POST MODAL -----------------
function openModal(sponsorId) {
  document.getElementById("modalSponsorId").value = sponsorId;
  document.getElementById("postModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("postModal").style.display = "none";
  document.getElementById("postForm").reset();
  document.getElementById("modalPostId").value = "";
}

// ----------------- ADD / EDIT POST -----------------
document.getElementById("postForm").addEventListener("submit", async e => {
  e.preventDefault();
  const sponsorId = document.getElementById("modalSponsorId").value;
  const postId = document.getElementById("modalPostId").value;
  const isEditing = Boolean(postId);

  const formData = new FormData();
  const mediaFile = document.getElementById("postMedia").files[0];
  if (mediaFile) {
    const isValidType = mediaFile.type.startsWith("image/") || mediaFile.type.startsWith("video/");
    if (!isValidType) {
      alert("Media must be an image or video file");
      return;
    }
    if (mediaFile.size > 25 * 1024 * 1024) {
      alert("Media file too large (max 25MB)");
      return;
    }
    formData.append("media", mediaFile);
  }

  const caption = document.getElementById("postCaption").value.trim() || "No caption provided";
  const jobLink = document.getElementById("jobLink").value.trim() || "#";
  formData.append("caption", caption);
  formData.append("jobLink", jobLink);

  const url = isEditing
    ? `/api/sponsors/${sponsorId}/posts/${postId}`
    : `/api/sponsors/${sponsorId}/post`;

  try {
    const res = await fetch(url, {
      method: "PUT",
      headers: { "Authorization": "Bearer " + token },
      body: formData
    });
    const result = await res.json();

    if (res.ok) {
      alert(isEditing ? "‚úÖ Post updated" : "‚úÖ Post added");
      closeModal();
      const showBtn = document.querySelector(`[onclick="togglePosts('${sponsorId}', this)"]`);
      if (showBtn && showBtn.textContent === "Hide Posts") togglePosts(sponsorId, showBtn);
    } else {
      console.error("Post Error:", result);
      alert("‚ùå Failed to save post. " + (result.message || ""));
    }
  } catch (err) {
    console.error("Post Exception:", err);
    alert("‚ùå Network or server error occurred.");
  }
});

// ----------------- FETCH / TOGGLE POSTS -----------------
async function togglePosts(sponsorId, btn) {
  const postContainer = document.getElementById(`posts-${sponsorId}`);
  if (postContainer.style.display === "none") {
    try {
      const res = await fetch(`/api/sponsors/${sponsorId}/posts`, { headers: { "Authorization": "Bearer " + token } });
      const posts = await res.json();
      postContainer.innerHTML = "";

      if (Array.isArray(posts) && posts.length > 0) {
        posts.forEach(post => {
          const div = document.createElement("div");
          div.className = "post-card";
          div.innerHTML = `
            ${post.media ? `<img src="${post.media}" width="100" />` : ""}
            <p><strong>Caption:</strong> ${post.caption}</p>
            <p><a href="${post.jobLink}" target="_blank">View Job Link</a></p>
            <p>üëÅÔ∏è ${post.views || 0} views | üîó ${post.clicks || 0} clicks</p>
            <button onclick="editPost('${sponsorId}','${post._id}','${post.caption}','${post.jobLink}')">‚úèÔ∏è Edit</button>
            <button onclick="deletePost('${sponsorId}','${post._id}')">üóëÔ∏è Delete</button>
            <hr>
          `;
          postContainer.appendChild(div);
        });
      } else postContainer.innerHTML = "<em>No posts yet.</em>";

      postContainer.style.display = "block";
      btn.textContent = "Hide Posts";
    } catch (err) {
      console.error("Toggle Posts Error:", err);
      postContainer.innerHTML = "‚ùå Error loading posts";
      postContainer.style.display = "block";
    }
  } else {
    postContainer.style.display = "none";
    btn.textContent = "Show Posts";
  }
}

function editPost(sponsorId, postId, caption, jobLink) {
  openModal(sponsorId);
  document.getElementById("modalPostId").value = postId;
  document.getElementById("postCaption").value = caption;
  document.getElementById("jobLink").value = jobLink;
}

// ----------------- DELETE POST -----------------
async function deletePost(sponsorId, postId) {
  if (!confirm("Are you sure you want to delete this post?")) return;

  const res = await fetch(`/api/sponsors/${sponsorId}/posts/${postId}`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  });

  if (res.ok) {
    alert("‚úÖ Post deleted");
    const showBtn = document.querySelector(`[onclick="togglePosts('${sponsorId}', this)"]`);
    if (showBtn && showBtn.textContent === "Hide Posts") togglePosts(sponsorId, showBtn);
  } else {
    const result = await res.json();
    console.error("Delete Post Error:", result);
    alert("‚ùå Failed to delete post. " + (result.message || ""));
  }
}

// ----------------- INIT -----------------
fetchUserCount();
fetchSponsors();

// ----------------- PREVIEWS -----------------
document.getElementById("logo").addEventListener("change", () => {
  const file = document.getElementById("logo").files[0];
  const box = document.getElementById("logoPreview");
  if (!file) { box.style.display = "none"; box.innerHTML = ""; return; }
  const url = URL.createObjectURL(file);
  box.innerHTML = `<img src="${url}" alt="Logo Preview" />`;
  box.style.display = "block";
});

document.getElementById("postMedia").addEventListener("change", () => {
  const file = document.getElementById("postMedia").files[0];
  const box = document.getElementById("postMediaPreview");
  if (!file) { box.style.display = "none"; box.innerHTML = ""; return; }
  const url = URL.createObjectURL(file);
  if (file.type.startsWith("image/")) {
    box.innerHTML = `<img src="${url}" alt="Media Preview" />`;
  } else if (file.type.startsWith("video/")) {
    box.innerHTML = `<video src="${url}" controls></video>`;
  } else {
    box.innerHTML = `<p>Unsupported file type</p>`;
  }
  box.style.display = "block";
});
</script>

  
</body>
</html>
