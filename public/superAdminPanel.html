<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SuperAdmin Panel</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="theme.css">
  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas for converting HTML to canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
    h1 { color: #333; }
    .section {
      margin-bottom: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    input, select, button {
      padding: 8px;
      margin: 5px 0;
    }
    .code-box {
      font-family: monospace;
      background: #e8f5e9;
      padding: 10px;
      border-left: 5px solid green;
      border-radius: 5px;
      margin-top: 10px;
    }
    .user-card {
      background: #fafafa;
      padding: 10px;
      border: 1px solid #ddd;
      margin: 5px 0;
      border-radius: 6px;
    }
    .promote-btn {
      margin-left: 10px;
      padding: 4px 8px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .promote-btn:hover {
      background-color: #0056b3;
    }
    
    /* Statistics Section Styles */
    .stats-display {
      margin-top: 15px;
    }
    .stats-container {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #e9ecef;
    }
    .stats-header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #007bff;
      padding-bottom: 15px;
    }
    .stats-header h4 {
      color: #007bff;
      margin: 0 0 10px 0;
    }
    .stats-timestamp {
      color: #6c757d;
      font-size: 0.9em;
      margin: 5px 0;
    }
    .total-users {
      font-weight: bold;
      color: #28a745;
      font-size: 1.1em;
      margin: 5px 0;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .stats-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-left: 4px solid #007bff;
    }
    .stats-card h5 {
      color: #495057;
      margin: 0 0 15px 0;
      font-size: 1.1em;
    }
    .stats-content {
      font-size: 0.9em;
    }
    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f1f3f4;
    }
    .stat-item:last-child {
      border-bottom: none;
    }
    .stat-label {
      font-weight: 500;
      color: #495057;
    }
    .stat-value {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .stat-count {
      background: #e9ecef;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      color: #495057;
    }
    .stat-percentage {
      font-weight: bold;
      color: #007bff;
    }
    .btn-success {
      background-color: #28a745;
      border-color: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    .btn-success:hover {
      background-color: #218838;
      border-color: #1e7e34;
    }
    
    /* Charts Section Styles */
    .charts-section {
      margin: 30px 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
    }
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-left: 4px solid #007bff;
    }
    .chart-container h5 {
      color: #495057;
      margin: 0 0 20px 0;
      font-size: 1.1em;
      text-align: center;
    }
    .chart-container canvas {
      max-height: 300px;
      width: 100% !important;
    }
    
    /* Download Button Styles */
    .download-btn {
      margin: 15px 0;
      background: linear-gradient(135deg, #007bff, #0056b3);
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    .download-btn:hover {
      background: linear-gradient(135deg, #0056b3, #004085);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,123,255,0.4);
    }
    .download-btn i {
      margin-right: 8px;
    }
    
    /* Enhanced Stats Grid */
    .stats-grid {
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <h1>üëë SuperAdmin Panel</h1>
<button 
  style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;"
  onclick="window.location='dashboard.html'">
  <i class="fa fa-home"></i>
</button>

  <!-- üîê Generate Invite Token -->
  <div class="section">
    <h3>üîê Generate Admin Invite Token</h3>
    <label for="role">Select Role:</label>
    <select id="role">
      <option value="admin">Admin</option>
      <option value="superadmin">SuperAdmin</option>
    </select>
    <br>
    <button onclick="generateToken()">Generate Token</button>
    <div id="tokenBox" class="code-box" style="display:none;"></div>
  </div>

  <!-- üßë Promote User -->
  <div class="section">
    <h3>üßë Promote User to Admin</h3>
    <input type="text" id="promoteUsername" placeholder="Enter username" />
    <button onclick="promoteUser()">Promote</button>
    <div id="promoteMsg" class="code-box" style="display:none;"></div>
  </div>

  <!-- üìä Generate Statistics/Analytics -->
  <div class="section">
    <h3>üìä Generate Statistics/Analytics</h3>
    <div class="admin-actions">
      <button id="generateStatsBtn" class="btn btn-success">Generate User Statistics</button>
      <div id="statsDisplay" class="stats-display" style="display: none;">
        <div class="stats-container">
          <div class="stats-header">
            <h4>üìà User Analytics Report</h4>
            <p id="statsGeneratedAt" class="stats-timestamp"></p>
            <p id="totalUsersCount" class="total-users"></p>
            <button id="downloadPdfBtn" class="btn btn-primary download-btn">
              <i class="fas fa-download"></i> Download PDF Report
            </button>
          </div>
          
          <!-- Charts Section -->
          <div class="charts-section">
            <div class="chart-container">
              <h5>üåç Location Distribution</h5>
              <canvas id="locationChart"></canvas>
            </div>
            
            <div class="chart-container">
              <h5>üéÇ Age Range Distribution</h5>
              <canvas id="ageChart"></canvas>
            </div>
            
            <div class="chart-container">
              <h5>üë• Gender Distribution</h5>
              <canvas id="genderChart"></canvas>
            </div>
            
            <div class="chart-container">
              <h5>üìÖ Registration Timeline</h5>
              <canvas id="timelineChart"></canvas>
            </div>
          </div>
          
          <!-- Detailed Statistics Tables -->
          <div class="stats-grid">
            <div class="stats-card">
              <h5>üåç Location Distribution</h5>
              <div id="locationStats" class="stats-content"></div>
            </div>
            
            <div class="stats-card">
              <h5>üéÇ Age Range Distribution</h5>
              <div id="ageRangeStats" class="stats-content"></div>
            </div>
            
            <div class="stats-card">
              <h5>üë• Gender Distribution</h5>
              <div id="genderStats" class="stats-content"></div>
            </div>
            
            <div class="stats-card">
              <h5>üìÖ Registration Timeline</h5>
              <div id="registrationTimeline" class="stats-content"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<hr>
<h3>Demote Admin to User</h3>
<input type="text" id="demoteUsername" placeholder="Username to demote">
<button onclick="demoteUser()">Demote</button>
<div id="demoteMsg" style="color: orange; margin-top: 5px;"></div>


  <!-- üë• View All Users -->
  <div class="section">
    <h3>üë• All Users</h3>
    <div id="userList">Loading users...</div>
  </div>


  <script>
  // üõ°Ô∏è SuperAdmin Page Protection
  const currentUser = JSON.parse(localStorage.getItem("currentUser"));
  const token = localStorage.getItem("token");

  if (!currentUser || currentUser.role !== "superadmin" || !token) {
    alert("‚õî Access denied. SuperAdmin only.");
    window.location.replace("dashboard.html"); // or "Sign Up Page.html"
  }

  // ‚úÖ Fetch Admin Invite Token
  async function generateToken() {
    const role = document.getElementById("role").value;
    const res = await fetch("/api/admin/generate-invite", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ role })
    });

    const data = await res.json();
    const tokenBox = document.getElementById("tokenBox");
    tokenBox.style.display = "block";

    if (res.ok) {
      tokenBox.innerText = "Invite Token:\n" + data.inviteToken;
    } else {
      tokenBox.innerText = data.message || "Error generating token";
    }
  }

  // ‚úÖ Promote a user to Admin
  async function promoteUser() {
    const username = document.getElementById("promoteUsername").value;
    const res = await fetch(`/api/admin/promote/${username}`, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    const data = await res.json();
    const msgBox = document.getElementById("promoteMsg");
    msgBox.style.display = "block";
    msgBox.innerText = data.message || "Failed to promote user";
    fetchUsers(); // refresh user list
  }

  // ‚úÖ List all users
  async function fetchUsers() {
    const res = await fetch("/api/admin/users", {
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    const data = await res.json();
    const container = document.getElementById("userList");
    container.innerHTML = "";

    if (res.ok && Array.isArray(data.users)) {
      data.users.forEach(user => {
        const div = document.createElement("div");
        div.className = "user-card";
        div.innerHTML = `
          <strong>${user.username}</strong> (${user.role || "user"})<br>
          ${user.email}
        `;
        container.appendChild(div);
      });
    } else {
      container.innerText = "Failed to load users.";
    }
  }

  fetchUsers();

  // üìä Generate User Statistics
  async function generateUserStats() {
    const button = document.getElementById("generateStatsBtn");
    const statsDisplay = document.getElementById("statsDisplay");
    
    // Show loading state
    button.textContent = "Generating...";
    button.disabled = true;
    
    try {
      const res = await fetch("/api/stats/user-analytics", {
        headers: {
          "Authorization": "Bearer " + token
        }
      });

      const data = await res.json();
      
      if (res.ok && data.success) {
        displayStatistics(data.analytics);
        statsDisplay.style.display = "block";
      } else {
        alert("Failed to generate statistics: " + (data.message || "Unknown error"));
      }
    } catch (error) {
      console.error("Statistics Error:", error);
      alert("Failed to generate statistics. Please try again.");
    } finally {
      // Reset button state
      button.textContent = "Generate User Statistics";
      button.disabled = false;
    }
  }

  // üìà Display Statistics Data
  function displayStatistics(analytics) {
    // Update header information
    document.getElementById("statsGeneratedAt").textContent = 
      `Generated on: ${new Date(analytics.generatedAt).toLocaleString()}`;
    document.getElementById("totalUsersCount").textContent = 
      `Total Users: ${analytics.totalUsers}`;

    // Display Location Statistics
    const locationContainer = document.getElementById("locationStats");
    locationContainer.innerHTML = "";
    Object.entries(analytics.locationStatistics).forEach(([location, data]) => {
      const item = document.createElement("div");
      item.className = "stat-item";
      item.innerHTML = `
        <span class="stat-label">${location}</span>
        <div class="stat-value">
          <span class="stat-count">${data.count}</span>
          <span class="stat-percentage">${data.percentage}%</span>
        </div>
      `;
      locationContainer.appendChild(item);
    });

    // Display Age Range Statistics
    const ageContainer = document.getElementById("ageRangeStats");
    ageContainer.innerHTML = "";
    Object.entries(analytics.ageRangeStatistics).forEach(([range, data]) => {
      const item = document.createElement("div");
      item.className = "stat-item";
      item.innerHTML = `
        <span class="stat-label">${range}</span>
        <div class="stat-value">
          <span class="stat-count">${data.count}</span>
          <span class="stat-percentage">${data.percentage}%</span>
        </div>
      `;
      ageContainer.appendChild(item);
    });

    // Display Gender Statistics
    const genderContainer = document.getElementById("genderStats");
    genderContainer.innerHTML = "";
    Object.entries(analytics.genderStatistics).forEach(([gender, data]) => {
      const item = document.createElement("div");
      item.className = "stat-item";
      item.innerHTML = `
        <span class="stat-label">${gender}</span>
        <div class="stat-value">
          <span class="stat-count">${data.count}</span>
          <span class="stat-percentage">${data.percentage}%</span>
        </div>
      `;
      genderContainer.appendChild(item);
    });

    // Display Registration Timeline
    const timelineContainer = document.getElementById("registrationTimeline");
    timelineContainer.innerHTML = "";
    Object.entries(analytics.registrationTimeline).forEach(([month, count]) => {
      const item = document.createElement("div");
      item.className = "stat-item";
      item.innerHTML = `
        <span class="stat-label">${month}</span>
        <div class="stat-value">
          <span class="stat-count">${count}</span>
        </div>
      `;
      timelineContainer.appendChild(item);
    });

    // Create interactive charts
    setTimeout(() => {
      createCharts(analytics);
    }, 100); // Small delay to ensure DOM is ready
  }

  // Add event listener for the statistics button
  document.getElementById("generateStatsBtn").addEventListener("click", generateUserStats);

  // üìä Charts Management
  let chartInstances = {};

  // üìà Create Charts
  function createCharts(analytics) {
    // Destroy existing charts
    Object.values(chartInstances).forEach(chart => {
      if (chart) chart.destroy();
    });
    chartInstances = {};

    // Location Chart (Pie Chart)
    const locationCtx = document.getElementById('locationChart').getContext('2d');
    const locationData = Object.entries(analytics.locationStatistics);
    chartInstances.location = new Chart(locationCtx, {
      type: 'pie',
      data: {
        labels: locationData.map(([location]) => location),
        datasets: [{
          data: locationData.map(([, data]) => data.count),
          backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
            '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
          ],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed;
                const percentage = locationData.find(([loc]) => loc === label)[1].percentage;
                return `${label}: ${value} users (${percentage}%)`;
              }
            }
          }
        }
      }
    });

    // Age Range Chart (Bar Chart)
    const ageCtx = document.getElementById('ageChart').getContext('2d');
    const ageData = Object.entries(analytics.ageRangeStatistics);
    chartInstances.age = new Chart(ageCtx, {
      type: 'bar',
      data: {
        labels: ageData.map(([range]) => range),
        datasets: [{
          label: 'Users',
          data: ageData.map(([, data]) => data.count),
          backgroundColor: 'rgba(54, 162, 235, 0.8)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const percentage = ageData[context.dataIndex][1].percentage;
                return `${context.parsed.y} users (${percentage}%)`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });

    // Gender Chart (Doughnut Chart)
    const genderCtx = document.getElementById('genderChart').getContext('2d');
    const genderData = Object.entries(analytics.genderStatistics);
    chartInstances.gender = new Chart(genderCtx, {
      type: 'doughnut',
      data: {
        labels: genderData.map(([gender]) => gender),
        datasets: [{
          data: genderData.map(([, data]) => data.count),
          backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
          borderWidth: 3,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed;
                const percentage = genderData.find(([gender]) => gender === label)[1].percentage;
                return `${label}: ${value} users (${percentage}%)`;
              }
            }
          }
        }
      }
    });

    // Registration Timeline Chart (Line Chart)
    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    const timelineData = Object.entries(analytics.registrationTimeline);
    chartInstances.timeline = new Chart(timelineCtx, {
      type: 'line',
      data: {
        labels: timelineData.map(([month]) => month),
        datasets: [{
          label: 'New Registrations',
          data: timelineData.map(([, count]) => count),
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: 'rgba(75, 192, 192, 1)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          },
          x: {
            ticks: {
              maxRotation: 45
            }
          }
        }
      }
    });
  }

  // üìÑ PDF Download Functionality
  async function downloadPDF() {
    const button = document.getElementById("downloadPdfBtn");
    const originalText = button.innerHTML;
    
    try {
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
      button.disabled = true;

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      
      // Add title and header
      pdf.setFontSize(20);
      pdf.setTextColor(0, 123, 255);
      pdf.text('User Analytics Report', 20, 25);
      
      pdf.setFontSize(12);
      pdf.setTextColor(100, 100, 100);
      const generatedAt = document.getElementById("statsGeneratedAt").textContent;
      const totalUsers = document.getElementById("totalUsersCount").textContent;
      pdf.text(generatedAt, 20, 35);
      pdf.text(totalUsers, 20, 42);
      
      let yPosition = 55;

      // Capture charts as images and add to PDF
      const chartContainers = document.querySelectorAll('.chart-container');
      
      for (let i = 0; i < chartContainers.length; i++) {
        const container = chartContainers[i];
        const canvas = await html2canvas(container, {
          backgroundColor: '#ffffff',
          scale: 2,
          logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 170;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        // Add new page if needed
        if (yPosition + imgHeight > 280) {
          pdf.addPage();
          yPosition = 20;
        }
        
        pdf.addImage(imgData, 'PNG', 20, yPosition, imgWidth, imgHeight);
        yPosition += imgHeight + 15;
      }

      // Add detailed statistics tables
      pdf.addPage();
      yPosition = 25;
      
      pdf.setFontSize(16);
      pdf.setTextColor(0, 123, 255);
      pdf.text('Detailed Statistics', 20, yPosition);
      yPosition += 15;

      // Location Statistics
      pdf.setFontSize(14);
      pdf.setTextColor(0, 0, 0);
      pdf.text('Location Distribution:', 20, yPosition);
      yPosition += 10;
      
      const locationStats = document.getElementById('locationStats').children;
      for (let i = 0; i < locationStats.length; i++) {
        const item = locationStats[i];
        const label = item.querySelector('.stat-label').textContent;
        const count = item.querySelector('.stat-count').textContent;
        const percentage = item.querySelector('.stat-percentage').textContent;
        
        pdf.setFontSize(10);
        pdf.text(`${label}: ${count} users (${percentage})`, 25, yPosition);
        yPosition += 6;
        
        if (yPosition > 270) {
          pdf.addPage();
          yPosition = 25;
        }
      }

      // Save the PDF
      const timestamp = new Date().toISOString().split('T')[0];
      pdf.save(`User_Analytics_Report_${timestamp}.pdf`);
      
    } catch (error) {
      console.error('PDF Generation Error:', error);
      alert('Failed to generate PDF. Please try again.');
    } finally {
      button.innerHTML = originalText;
      button.disabled = false;
    }
  }

  // Add event listener for PDF download
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('downloadPdfBtn').addEventListener('click', downloadPDF);
  });

  // üîª Demote an Admin to User
async function demoteUser() {
  const username = document.getElementById("demoteUsername").value;
  const res = await fetch(`/api/admin/demote/${username}`, {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + token
    }
  });

  const data = await res.json();
  const msgBox = document.getElementById("demoteMsg");
  msgBox.style.display = "block";
  msgBox.innerText = data.message || "Failed to demote user.";
  fetchUsers(); // refresh user list
}
</script>
<script src="theme.js" defer></script>

</body>
</html>
