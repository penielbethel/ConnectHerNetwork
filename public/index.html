<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ConnectHer Network</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="theme.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      box-sizing: border-box;
    }

    body, html {
      width: 100%;
      height: 100%;
      background: #0e0e0e;
      color: #fff;
    }
body {
  background-color: var(--bg);
  color: var(--text);
}
    #preloader {
      position: fixed;
      width: 100%;
      height: 100%;
      background: #0e0e0e;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    #preloader img {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
    }

    .dot-container {
      display: flex;
      justify-content: center;
      gap: 6px;
    }

    .dot {
      width: 8px;
      height: 8px;
      background: #ccc;
      border-radius: 50%;
      animation: blink 1.2s infinite ease-in-out;
    }

    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    .dot:nth-child(4) { animation-delay: 0.6s; }
    .dot:nth-child(5) { animation-delay: 0.8s; }

    @keyframes blink {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }

    #preloader .meta-text {
      margin-top: 30px;
      font-size: 14px;
      color: #aaa;
    }
.signup-step {
  opacity: 0;
  max-height: 0;
  overflow: hidden;
  transition: all 0.4s ease;
}

.signup-step.visible {
  opacity: 1;
  max-height: 100px;
  margin-top: 12px;
}

#signup-form input,
#signup-form select,
#signup-form .date-input-wrapper,
#signup-form .custom-file-upload {
  width: 100%; /* Match width of First Name input */
}


    .container {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      max-width: 500px;
      margin: 0 auto;
    }

    .container img {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      border-radius: 12px;
    }

    h1, h2 {
      font-size: 24px;
      margin-bottom: 10px;
      color: #ffcce6;
      text-align: center;
    }

    p {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 20px;
      text-align: center;
    }

    form {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 15px;
    }

    input {
      padding: 14px;
      border: none;
      border-radius: 12px;
      background: #1a1a1a;
      color: #ffcce6;
      font-size: 16px;
      box-shadow: 0 0 8px #ff66cc40;
    }

    button {
      padding: 14px;
      background: #ff99cc;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      color: #0e0e0e;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #ff66b2;
    }

    .error {
      color: red;
      text-align: center;
      font-size: 14px;
    }

    .toggle-link {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
    }

    .toggle-link a {
      color: #ff99cc;
      text-decoration: underline;
      cursor: pointer;
    }

    .forgot {
      text-align: center;
      font-size: 14px;
    }

    .forgot a {
      color: #ff99cc;
      text-decoration: none;
    }

    @media screen and (max-width: 480px) {
      .container {
        padding: 30px 15px;
      }

      h1, h2 {
        font-size: 20px;
      }

      input, button {
        font-size: 15px;
        padding: 12px;
      }

      .container img {
        width: 60px;
        height: 60px;
      }
      select {
  padding: 14px;
  border: none;
  border-radius: 12px;
  background: #1a1a1a;
  color: #ffcce6;
  font-size: 16px;
  box-shadow: 0 0 8px #ff66cc40;
}
    }

    select {
  padding: 14px;
  border: none;
  border-radius: 12px;
  background: #1a1a1a;
  color: #ffcce6;
  font-size: 16px;
  box-shadow: 0 0 8px #ff66cc40;
}

 .custom-file-upload {
    display: inline-block;
    padding: 10px 20px;
    cursor: pointer;
    background-color: #d385bd;
    color: white;
    border-radius: 5px;
    font-family: sans-serif;
    font-size: 14px;
  }

  input[type="file"] {
    display: none;
  }

  .date-input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }

  .date-label {
    display: flex;
    align-items: center;
    font-size: 16px;
    color: #555;
    gap: 6px;
    white-space: nowrap;
  }

  .date-input-container {
    position: relative;
    flex-grow: 1;
  }

  .date-input-container input[type="date"] {
    width: 100%;
    padding: 10px 12px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
    appearance: none;
    background-color: #f189b3;
  }

  /* Hide placeholder-like text in iOS/Safari */
  .date-input-container input[type="date"]:not(:valid)::-webkit-datetime-edit {
    color: transparent;
  }

  .date-input-container input[type="date"]:not(:valid)::before {
    content: attr(data-placeholder);
    color: #aaa;
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
  }

  .hidden {
  display: none;
}


  </style>
</head>
<body>

<!-- Preloader -->
<div id="preloader">
  <img src="/logo.png" alt="ConnectHer Logo">
  <div class="dot-container">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>
  <div class="meta-text">ConnectHer Network</div>
</div>

<!-- Sign-Up Container -->
<div id="signup-container" class="container">
  <img src="/logo.png" alt="ConnectHer Logo">
  <h1>Sign Up for ConnectHer</h1>
<form id="signup-form" enctype="multipart/form-data">
  <input type="text" name="firstName" id="firstName" placeholder="First name" required>

  <div class="signup-step hidden"><input type="text" name="surname" placeholder="Surname" required></div>
  <div class="signup-step hidden"><input type="text" name="username" placeholder="Choose a username" required></div>
  <div class="signup-step hidden"><input type="email" name="email" placeholder="Email address" required></div>
  <div class="signup-step hidden">
    <input type="password" name="password" id="signupPassword" placeholder="Password" required>
  </div>
  <div class="signup-step hidden">
    <select name="gender" id="gender" required>
      <option value="Female" selected>Female</option>
      <option value="Company">Company</option>
    </select>
  </div>
  <div class="signup-step hidden">
    <div class="date-input-wrapper">
      <label class="date-label" for="birthday">
        <i class="fa fa-calendar-alt"></i>
        Enter your Date of Birth
      </label>
      <div class="date-input-container">
        <input
          type="date"
          id="birthday"
          name="birthday"
          required
          onfocus="(this.type='date')"
          onblur="if(!this.value)this.type='text'"
        />
      </div>
    </div>
  </div>
  <div class="signup-step hidden"><input type="text" name="location" id="location" placeholder="Location" required></div>
  <div class="signup-step hidden">
    <label for="avatar" class="custom-file-upload">Upload Profile Picture</label>
    <input type="file" id="avatar" name="avatar" accept="image/*" required>
  </div>
  <div class="signup-step hidden"><input type="text" name="adminToken" placeholder="Admin Token (if provided)" /></div>

  <button type="submit" class="signup-step hidden">Sign Up</button>
  <div class="error" id="errorMsg"></div>
</form>


  <div class="toggle-link">Already Registered? <a onclick="toggleView('login')">Login Here</a></div>
</div>

<!-- Login Container -->
<div id="login-container" class="container">
  <img src="/logo.png" alt="ConnectHer Logo">
  <h2>Login</h2>
  <p>Sign in to continue</p>
  <form id="login-form">
    <input type="text" name="username" placeholder="Username/Email" required>
    <input type="password" name="password" placeholder="Password" required>
    <input type="text" name="otp" id="otpField" placeholder="Enter OTP" style="display:none;">
    <button type="submit">Log In</button>
    <div class="error" id="loginErrorMsg"></div>
  </form>
  <div class="forgot"><a href="#">Forgot Password?</a></div>

<!-- Forgot Password Modal -->
<div id="forgot-password-modal" style="display:none; flex-direction: column; gap: 10px; background: #1a1a1a; padding: 20px; border-radius: 12px; margin-top: 20px;">
  <input type="email" id="forgotEmail" placeholder="Input registered email" required>
  <button onclick="requestResetCode()">Send Reset Code</button>
  <input type="text" id="resetCode" placeholder="Enter received code" style="display:none;" required>
  <input type="password" id="newPassword" placeholder="Enter new password" style="display:none;" required>
  <button onclick="resetPassword()" style="display:none;" id="resetBtn">Reset Password</button>
  <div class="error" id="forgotErrorMsg"></div>
</div>


  <div class="toggle-link">New user? <a onclick="toggleView('signup')">Sign Up Here</a></div>

<script>
  // üö™ If already logged in, redirect to dashboard
  if (localStorage.getItem("username")) {
    window.location.href = "dashboard.html";
  }

  // üåê Preloader transition
  window.addEventListener('load', () => {
    setTimeout(() => {
      document.getElementById('preloader').style.display = 'none';
      document.getElementById('signup-container').style.display = 'flex';
    }, 3000);
  });

  // üîÅ Toggle between Signup/Login views
  function toggleView(view) {
    document.getElementById('signup-container').style.display = view === 'signup' ? 'flex' : 'none';
    document.getElementById('login-container').style.display = view === 'login' ? 'flex' : 'none';
  }

  // üìç Auto-fill location using browser geolocation
  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition((position) => {
      const { latitude, longitude } = position.coords;
      document.getElementById('location').value = `Lat: ${latitude}, Lng: ${longitude}`;
    });
  }

  // üìù Signup form submission
  document.getElementById('signup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;

    const formData = new FormData();
    formData.append("firstName", form.firstName.value);
    formData.append("surname", form.surname.value);
    formData.append("name", `${form.firstName.value} ${form.surname.value}`);
    formData.append("username", form.username.value);
    formData.append("email", form.email.value);
    formData.append("password", form.password.value);
    formData.append("birthday", form.birthday.value);
    formData.append("location", form.location.value);
    formData.append("gender", form.gender.value);
    formData.append("avatar", form.avatar.files[0]);
    formData.append("adminToken", form.adminToken.value);

    // Check password strength only for regular users
    const password = form.password.value;
    const adminToken = form.adminToken.value;
    const strongPasswordRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{6,}$/;

    if (!adminToken && !strongPasswordRegex.test(password)) {
    document.getElementById('errorMsg').textContent =
    "Password must include at least one uppercase letter, one number, and one special character.";
    return;
}

    try {
      const res = await fetch('https://connecther.network/api/auth/register', {
        method: 'POST',
        body: formData
      });

      const response = await res.json();

      if (res.ok) {
        const user = response.user;

        // ‚úÖ ADDED JOINED DATE FIX
        if (!user.joined) {
          user.joined = new Date().toISOString().split("T")[0];
        }

        // ‚úÖ Save logged-in user
        if (!user.name && user.firstName && user.surname) {
          user.name = `${user.firstName} ${user.surname}`;
        }

        localStorage.setItem("currentUser", JSON.stringify({
  username: user.username,
  name: user.name || `${user.firstName} ${user.surname}`,
  firstName: user.firstName,
  surname: user.surname,
  avatar: user.avatar,
  location: user.location,
  role: user.role
}));
        localStorage.setItem("username", user.username);

        // Optional: include in allUsers
        let allUsers = JSON.parse(localStorage.getItem("allUsers")) || [];
        allUsers = allUsers.filter(u => u.username !== user.username); // Remove any existing
        allUsers.push(user);
        localStorage.setItem("allUsers", JSON.stringify(allUsers));
        localStorage.setItem("pendingUser", JSON.stringify(user));
        window.location.replace("verification.html");
      } else {
        document.getElementById('errorMsg').textContent = response.message || "Registration failed.";
      }
    } catch {
      document.getElementById('errorMsg').textContent = "Cannot connect to server.";
    }
  });

  
 // üîê Login form submission (UPDATED WITH OTP)
let tempUserId = ""; // Track userId for OTP phase

document.getElementById('login-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const form = e.target;
  const input = form.username.value.trim();
  const password = form.password.value;
  const otp = form.otp.value;

  if (otp) {
    // üü° Second phase: OTP verification
    try {
      const res = await fetch('https://connecther.network/api/auth/verify-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: tempUserId, otpCode: otp })
      });

      const data = await res.json();

      if (res.ok) {
        alert("‚úÖ OTP verified! Logging in...");
        form.reset();

        const user = data.user;

        // ‚úÖ Save token
        if (data.token) {
          localStorage.setItem("token", data.token);
        }

        // ‚úÖ Patch missing data
        if (!user.joined) {
          user.joined = new Date().toISOString().split("T")[0];
        }
        if (!user.name && user.firstName && user.surname) {
          user.name = `${user.firstName} ${user.surname}`;
        }

        // ‚úÖ Store user info
        localStorage.setItem("username", user.username);
        localStorage.setItem("currentUser", JSON.stringify(user));

        // üîÅ Optional: Keep local cache of all users
        let allUsers = JSON.parse(localStorage.getItem("allUsers")) || [];
        allUsers = allUsers.filter(u => u.username !== user.username);
        allUsers.push(user);
        localStorage.setItem("allUsers", JSON.stringify(allUsers));

        // üîÅ Role-based redirect
        if (user.role === "superadmin") {
          window.location.replace("superAdminPanel.html");
        } else if (user.role === "admin") {
          window.location.replace("adminPanel.html");
        } else {
          window.location.href = "dashboard.html";
        }

      } else {
        document.getElementById('loginErrorMsg').textContent = data.message || "Invalid or expired OTP.";
      }

    } catch (err) {
      console.error("OTP Verification Error:", err);
      document.getElementById('loginErrorMsg').textContent = "Server error during OTP verification.";
    }

  } else {
    // üîµ First phase: username/password login
    try {
      const res = await fetch('https://connecther.network/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ identifier: input, password })
      });

      const data = await res.json();

      if (res.ok) {
        alert("üì© OTP sent to your email. Enter it to continue.");

        // Save temp userId for OTP phase
        tempUserId = data.userId;

        // Show OTP input field
        document.getElementById("otpField").style.display = "block";

        // Change button text to "Verify OTP"
        form.querySelector('button[type="submit"]').textContent = "Verify OTP";

      } else {
        document.getElementById('loginErrorMsg').textContent = data.message || "Login failed.";
      }

    } catch (err) {
      console.error("Login Error:", err);
      document.getElementById('loginErrorMsg').textContent = "Cannot connect to server.";
    }
  }
});


  // üëÅÔ∏è Toggle password visibility
  function togglePassword(inputId, iconElement) {
    const input = document.getElementById(inputId);
    if (input.type === "password") {
      input.type = "text";
      iconElement.textContent = "üôà";
    } else {
      input.type = "password";
      iconElement.textContent = "üëÅÔ∏è";
    }
  }

// üõéÔ∏è Toggle Forgot Password Modal
document.querySelector('.forgot a').addEventListener('click', (e) => {
  e.preventDefault();
  const modal = document.getElementById("forgot-password-modal");
  modal.style.display = modal.style.display === "none" ? "flex" : "none";
});


// üì§ Request Reset Code
async function requestResetCode() {
  const email = document.getElementById('forgotEmail').value.trim();
  if (!email) return alert("Please enter your email.");

  try {
    const res = await fetch('https://connecther.network/api/auth/forgot-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });

    const data = await res.json();
    if (res.ok) {
      alert("‚úÖ Reset code sent to your email.");
      document.getElementById('resetCode').style.display = "block";
      document.getElementById('newPassword').style.display = "block";
      document.getElementById('resetBtn').style.display = "block";
    } else {
      document.getElementById('forgotErrorMsg').textContent = data.message;
    }
  } catch (err) {
    document.getElementById('forgotErrorMsg').textContent = "Failed to connect to server.";
  }
}

// üîÅ Reset Password Using Code
async function resetPassword() {
  const email = document.getElementById('forgotEmail').value.trim();
  const code = document.getElementById('resetCode').value.trim();
  const newPassword = document.getElementById('newPassword').value.trim();

  if (!email || !code || !newPassword) return alert("All fields are required.");

  try {
    const res = await fetch('https://connecther.network/api/auth/reset-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, code, newPassword })
    });

    const data = await res.json();
    if (res.ok) {
      alert("‚úÖ Password has been reset successfully.");
      document.getElementById("forgot-password-modal").style.display = "none";
    } else {
      document.getElementById('forgotErrorMsg').textContent = data.message;
    }
  } catch (err) {
    document.getElementById('forgotErrorMsg').textContent = "Failed to reset password.";
  }
}

// üë£ Progressive field reveal on Sign Up
const formSteps = document.querySelectorAll("#signup-form .signup-step");
let currentStep = 0;

document.getElementById("firstName").addEventListener("input", function () {
  if (this.value.trim() !== "" && currentStep < formSteps.length) {
    formSteps[currentStep].classList.remove("hidden");
    currentStep++;
  }
});

formSteps.forEach((stepDiv, index) => {
  const input = stepDiv.querySelector("input, select");
  if (input) {
    input.addEventListener("input", () => {
      if (input.value.trim() !== "" && currentStep < formSteps.length) {
        formSteps[currentStep].classList.remove("hidden");
        currentStep++;
      }
    });
  }
});

// üë£ Progressive field reveal on Sign Up
const signupFields = document.querySelectorAll("#signup-form .signup-step");
let currentIndex = 0;

function handleFieldInput(index) {
  const current = signupFields[index];
  const input = current.querySelector("input, select, .date-input-wrapper");
  
  if (!input) return;

  const targetInput = input.querySelector("input, select") || input;
  targetInput.addEventListener("input", () => {
    if (targetInput.value.trim() !== "" && signupFields[index + 1]) {
      signupFields[index + 1].classList.add("visible");
      currentIndex++;
      handleFieldInput(currentIndex);
    }
  });
}

// Start listening once First Name is filled
document.getElementById("firstName").addEventListener("input", function () {
  if (this.value.trim() !== "") {
    signupFields[0].classList.add("visible");
    handleFieldInput(0);
  }
});
</script>
<script src="theme.js" defer></script>

</body>
</html>
